<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Authentication Test</title>
</head>
<body>
    <h1>WebSocket Authentication Test</h1>
    <div>
        <label for="token">Access Token:</label>
        <input type="text" id="token" style="width: 300px;" />
    </div>
    <div>
        <label for="room">Room ID:</label>
        <input type="text" id="room" value="1" />
    </div>
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()">Disconnect</button>
    <div>
        <label for="message">Message:</label>
        <input type="text" id="message" />
        <button onclick="sendMessage()">Send</button>
    </div>
    <div>
        <h3>Status:</h3>
        <pre id="status"></pre>
    </div>
    <div>
        <h3>Messages:</h3>
        <ul id="messages"></ul>
    </div>

    <script>
        let socket;
        
        function connect() {
            const token = document.getElementById('token').value;
            const roomId = document.getElementById('room').value;
            
            if (!token) {
                updateStatus('Error: Token is required');
                return;
            }
            
            const wsUrl = `ws://127.0.0.1:8000/ws/chat/chat_${roomId}/?token=${token}`;
            updateStatus(`Connecting to ${wsUrl}`);
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function(e) {
                updateStatus('Connected!');
            };
            
            socket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                addMessage(`Received: ${JSON.stringify(data)}`);
            };
            
            socket.onclose = function(e) {
                updateStatus(`Disconnected: code=${e.code}, reason=${e.reason}`);
            };
            
            socket.onerror = function(e) {
                updateStatus('Error: ' + e.message);
            };
        }
        
        function disconnect() {
            if (socket) {
                socket.close();
                socket = null;
            }
        }
        
        function sendMessage() {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                updateStatus('Error: Not connected');
                return;
            }
            
            const messageText = document.getElementById('message').value;
            const roomId = document.getElementById('room').value;
            
            const message = {
                type: 'chat_message',
                content: messageText,
                sender_id: 1, // Use your logged in user ID
                chatroom_id: parseInt(roomId),
                receiver_id: null // Group chat
            };
            
            socket.send(JSON.stringify(message));
            addMessage(`Sent: ${JSON.stringify(message)}`);
        }
        
        function updateStatus(text) {
            document.getElementById('status').textContent = text;
        }
        
        function addMessage(text) {
            const li = document.createElement('li');
            li.textContent = text;
            document.getElementById('messages').appendChild(li);
        }
        
        // Check if token is stored in localStorage
        window.addEventListener('DOMContentLoaded', () => {
            const storedToken = localStorage.getItem('access_token');
            if (storedToken) {
                document.getElementById('token').value = storedToken;
                updateStatus('Token loaded from localStorage');
            }
        });
    </script>
</body>
</html>
